<!doctype html>
<html class="theme-next ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="h7BaHlqi6VjlciSt0RF-KHgIXZcGfx3L3gyQ9qfx_ek" />










  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="wuxu, Golang, C, CPP, CS, PHP, " />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="Wu Xu的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Wu Xu">
<meta property="og:url" content="http://blog.wuxu92.com/page/12/index.html">
<meta property="og:site_name" content="Wu Xu">
<meta property="og:description" content="Wu Xu的个人博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Wu Xu">
<meta name="twitter:description" content="Wu Xu的个人博客">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'hide',
    motion: false
  };
</script>

  <title> Wu Xu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-72131273-1', 'auto');
  ga('send', 'pageview');
</script>





  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>
    <div class="bottomband"></div> <!-- add by wuxu -->
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Wu Xu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">关注C、Go、C++、JavaScript和Rust</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/golang-character-set-and-encoding/" itemprop="url">
                  Go 字符集与编码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-09T12:34:50+08:00" content="2015-11-09">
              2015-11-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><img src="/images/golang/gopher-banner-small.jpg" alt=""></p>
<p>Go原生支持Unicode，字符集与编码的问题在编程语言中是很重要的，尤其对于CJK(中日韩)开发者来说。以前很多开发推荐使用GBK编码，现在更加推荐使用UTF-8，虽然UTF-8编码需要更大的存储空间，但是它带来的便利性实在远超过那一些存储空间。现代语言一般都支持Unicode了。着一篇争取对Unicode，UTF-8，UTF-16，ISO-8859有一个系统的了解。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>最早的计算机系统都是使用 EBCDIC(扩展的二进制的十进制转换码) 和 ASCII 编码，因为那时候只是用一些英文字母数字，加减号和其他一些字符，字符并不多，但是随着Internet的发展，网络遍布全球。全球有大概6000种语言（其中3000种在巴布亚新几内亚…） ，为了更好地服务更多的人，我们需要为不同语言的用户提供不同的语言支持。</p>
<p>如果世界只需要 ASCII 编码，那样将会简单很多。但事实却是非常复杂的，现代项目都应该考虑 i18n 和 l10n, 分别代表 internationalisation 和 localisation。i18n指应用能处理各种各样不同的语言和文化， l10n 则是为某个特定的文化团体定制你的国际化应用。</p>
<p>更广泛的i8n不仅仅是文字编码的区别，还要考虑诸如颜色、音乐在不同语言文化中的不同代表意义。但这个领域太过复杂，暂时一般不考虑。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><h3 id="Character"><a href="#Character" class="headerlink" title="Character"></a>Character</h3><p>Character 就是字符， </p>
<blockquote>
<p>“the smallest component of written language that has a semantic<br>value</p>
</blockquote>
<p>当然字符也包括自然语言符号之外的一些控制字符。关于字符的内容，可以查看 <a href="https://en.wikipedia.org/wiki/Character" title="维基百科" target="_blank" rel="noopener">维基百科</a></p>
<p><strong>字符集，character code</strong> 字符编码就是将一个字符映射到一个整数，比如最常见的 ASCII编码，将 a 编码为 97（编码点,code point）， A编码为65.编码仍然是抽象的，它仍不是我们在文本或者TCP包中多见到的。</p>
<p><strong>Character encoding</strong> 注意code和encoding是不同的。字符编码（encoding）表示的是其二进制编码。诸如补码，反码等。代表字符 A 在二进制上是怎么存储的。</p>
<p>字符编码（英语：Character encoding）、字集码是把字符集中的字符编码为指定集合中某一对象（例如：比特模式、自然数序列、8位组或者电脉冲），以便文本在计算机中存储和通过通信网络的传递。常见的例子包括将拉丁字母表编码成摩斯电码和ASCII。其中，ASCII将字母、数字和其它符号编号，并用7比特的二进制来表示这个整数。通常会额外使用一个扩充的比特，以便于以1个字节的方式存储。</p>
<blockquote>
<p>按照惯例，人们认为字符集和字符编码是同义词。</p>
</blockquote>
<p><strong>传输编码/Transport encoding</strong>对一段在网络传输的数据需要如何确认它的字符集和编码呢？可以在传输的头部包含一段内容编码信息的内容，就像HTTP头那样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Type: text/html; charset=ISO-8859-4</span><br><span class="line">Content-Encoding: gzip</span><br></pre></td></tr></table></figure>
<p>但是我们要怎么读到这一段内容呢？因为它们也是要编码的，这就是一个现有鸡还是先有蛋的问题了。但是我们可以做一个约定，这些信息都使用 ASCII 编码，更明确一点就是 US ASCII。因为这一部分信息的内容的功能使用ASCII就能搞定了。</p>
<h2 id="常用编码"><a href="#常用编码" class="headerlink" title="常用编码"></a>常用编码</h2><h3 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII"></a>ASCII</h3><p>ASCII 编码大家都很熟悉了，大一的时候专业基础课接触到的就是这些内容。作为最常用的编码，ASCII使用的编码点使用7-bit。</p>
<h3 id="ISO-8859"><a href="#ISO-8859" class="headerlink" title="ISO 8859"></a>ISO 8859</h3><p>现在一个字节的标准是8个比特位，作为ASCII的扩展多出来128个编码点。一些列不同的编码集使用了这128个编码点，它们被一些欧洲语言使用，合起来就是 ISO-8859系列。 ISO-8859-1也就是常说的Latin-1，它涵盖了大部分的欧洲语言。<br>ISO-8859是一个系列，系列中所有的低128个编码点就是ASCII编码，以实现兼容。</p>
<p>早期的HTML标准推荐使用ISO-8859-1字符集。不过在 HTML 4 之后就推荐使用 Unicode了。</p>
<h3 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h3><p>像ASCII和ISO8859这样的编码在象形文字（中日韩）语言面前显得就太小气了。中文常用的字多大几千个，至少需要两个字节才能涵括。最初没有统一的国际标准，因此出现了很多的2字节编码方案，比如台湾的Big5，国内的GB2312，BGK；再考虑日本的JIS X 0208等等，字符集简直是一个大乱斗。</p>
<p>Unicode是一个包含所有主要当前在用字符的新的标准，它包括了欧洲，亚洲，印度等等各种语言，Unicode的好处是它是可扩展的。到5.2版本，一共有超过 107000个字符。</p>
<p>Unicode编码点是兼容ISO8859的，也就是说它的前256个编码点就是ISO 8859-1.</p>
<p>要在计算机系统表示一个Unicode字符，需要使用一种编码方式。UCS（通用编码方式）使用两个字节进行编码，然而随着Unicod囊括的字符越来越多，UCS不再使用，而是使用 UTF-*的编码。UTF即 Unicode Transformation format.常见的编码方式如下：</p>
<ul>
<li>UTF-32 试用4字节编码，不常用，尤其是 HTML5 规范明确反对使用它</li>
<li>UTF-16 将最常用的字符编码到2字节，应该也不常用</li>
<li>UTF-8  一个字符使用1-4字节，不定长度，最常用的，对英文字符基本和ISO-8859对应，中文编码为3字符，相比GBK多一个字节</li>
<li>UTF-7  有时使用，但不常用</li>
</ul>
<p>要理解Unicode和UTF-8之间的区别和联系。知道UTF的名字是Unicode转换格式就可以了。Unicode是一个字符集，UTF-8是这个字符集的一种编码方式。</p>
<h2 id="Go与字符集"><a href="#Go与字符集" class="headerlink" title="Go与字符集"></a>Go与字符集</h2><h3 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h3><p>UTF-8 是当前最常用的字符编码，据Google统计50%的网页使用UTF-8编码。我们知道UTF-8的发明者就是Go的作者，也就是Unix的作者Ken。Go使用UTF-8编码的字符组成其字符串。Go的字符串的每一个字符称为一个 <code>rune</code>，它是 <code>int32</code>的别名，因为一个Unicode字符的长度可能是1，2，3，4个字节，如果要统计字符数，就需要计算的是rune的个数而不是字节数了。字符数和字节数只有在是字符串只由ASCII字符组成时才是一样的。</p>
<p>下面是一个中文字符串的示例，它表示出Go中字符串中不同字符占用长度不一样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str := &quot;百度一下，你就知道&quot;</span><br><span class="line">fmt.Println(&quot;string len:&quot;, len([]rune(str)))    // 9</span><br><span class="line">fmt.Println(&quot;Byte len&quot;, len(str))				// 27</span><br></pre></td></tr></table></figure>
<p>Go默认就是utf-8编码，所以如果你的项目要使用UTF-8的话，不需要做额外的字符集处理就可以了。</p>
<h3 id="UTF-16"><a href="#UTF-16" class="headerlink" title="UTF-16"></a>UTF-16</h3><h3 id="ISO-8859-1"><a href="#ISO-8859-1" class="headerlink" title="ISO 8859"></a>ISO 8859</h3>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/refactoring-method-call/" itemprop="url">
                  重构：简化函数调用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-09T12:34:50+08:00" content="2015-11-09">
              2015-11-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/软件工程/" itemprop="url" rel="index">
                    <span itemprop="name">软件工程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>有时间再补</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/npwg-application-level-protocols/" itemprop="url">
                  Go 应用层协议
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-07T12:34:50+08:00" content="2015-11-07">
              2015-11-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><img src="/images/golang/gopher-banner-small.jpg" alt=""></p>
<blockquote>
<p>这两天状态不太好，这一篇写的很糟糕</p>
</blockquote>
<p>在端到端的通信中，是两个程序之间的通信，除了TCP/UDP这样的传输层协议外，我们需要应用之间的通信的协议，这样才能利用/理解传输的数据，这就是我们这一篇的应用层协议。</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>应用之间的通信协议设计要考虑下面的问题：</p>
<ul>
<li>广播还是点对点？广播必须是UDP，本地多播或者更加实验性质的MBONE，点对点则可以是UDP和TCP</li>
<li>有状态还是无状态的？有状态的连接对应用更简便，但是要考虑连接奔溃的时候怎么办</li>
<li>传输层协议是否是可靠的？可靠连接一般更慢，但是就不需要担心丢包了，在内网的话UDP的可靠性也是非常高的</li>
<li>是否需要回复(reply)?接收端是否需要给发送方返回一个收到确认，如果要的话要考虑确认丢失，可能要使用超时</li>
<li>使用什么样的数据格式？通常会使用MIME规定的类型，或者使用字节编码数据</li>
<li>是否有突发性大流量的情况？这要考虑QoS(服务质量)，如果突然流量爆发如何处理。</li>
<li>多个流是否有同步的要求？比如视频和音频需要同步时间轴</li>
<li>是一个独立的应用还是为其他人提供的库？</li>
</ul>
<p>设计一个应用层协议，上面是最基本要考虑的点。</p>
<h2 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h2><p>消息的数据有两种主要的数据格式，一种是字节编码(byte encoded)，一种是字符编码(character encoded).</p>
<h3 id="字节格式"><a href="#字节格式" class="headerlink" title="字节格式"></a>字节格式</h3><p>使用字节编码格式的数据一般使用第一个字节来区分消息类型。消息的处理器（handler）通过检查第一个字节转向不同的处理流程(不同的消息对应不同的请求)。其他字节是根据某种规定的规则序列化的数据体。</p>
<p>使用字节的优势是数据密度高也因此速度很快，其缺点是数据不透明，这其实也算一个好处，这样别人就难以逆向工程了。如果出现错误将很难被发现，很难调试。常用使用这种格式的是DNS、NFS到Skype。</p>
<p>针对字节数据，Conn 类型提供了读取字节的方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func (c Conn) Read(b []byte) (n int, err os.Error)</span><br><span class="line">func (c Conn) Write(b []byte) (n int err os.Error)</span><br></pre></td></tr></table></figure>
<h3 id="字符格式"><a href="#字符格式" class="headerlink" title="字符格式"></a>字符格式</h3><p>使用base64编码后或者将二进制流转变成7-bit使用ascii字符发送。<br>字符格式通常使用多行形式的消息。第一行通常代表消息类型，剩余的数据是消息体数据。常使用行处理的函数。<br>在Go中没有管理字符流的直接支持，只能手动执行“换行”，要注意的是不同操作系统的换行很不一样， Unix系统使用’\n’ 代表换行，Windows系统使用”\r\n”换行，<strong>在internet上”\r\n”更加常用</strong>。</p>
<h2 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h2><p>应用需要管理状态信息来简化当前的操作，可以使用状态来保存应用信息。状态可以由服务器管理也可以由客户端管理。<br>可以使用应用状态转移图表设计状态系统。状态转移图可以跟踪应用的状态以及何时转移到新的状态。</p>
<blockquote>
<p>这一章主要是概念性的东西，状态不太好，记的很乱，ごめ</p>
</blockquote>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/my-git-config/" itemprop="url">
                  我的git配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-06T12:34:50+08:00" content="2015-11-06">
              2015-11-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/self/" itemprop="url" rel="index">
                    <span itemprop="name">self</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><img src="/images/post/git.jpg" alt=""></p>
<p>gitconfig的配置非常重要，有时候换到一台新机器由于没有自己配置搞得很不顺手，干脆把gitconfig摘出来，方便以后配置。<br>主要是命令别名的配置。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[user]</span><br><span class="line">        name = wuxu92</span><br><span class="line">        email = wuxu92@163.com</span><br><span class="line">[<span class="built_in">alias</span>]</span><br><span class="line">        lg = <span class="built_in">log</span> --graph --pretty=format:<span class="string">'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr)%Creset [%an]'</span> --abbrev-commit --date=relative</span><br><span class="line">        ls = ls --show-control-chars --color=auto</span><br><span class="line">        go = <span class="string">"! bash -c \"git pull &amp;&amp; git add .; if [ \\\"\\\" == \\\"\\\" ]; then git commit -a; else git commit -am \\\\¡\\\\¡; fi; git push origin master:yy</span></span><br><span class="line"><span class="string">our-id;\""</span></span><br><span class="line">        ci= commit</span><br><span class="line">        co = checkout</span><br><span class="line">        br = branch</span><br><span class="line">        st = status</span><br><span class="line">        list = <span class="built_in">log</span> --pretty=format:\<span class="string">"%h %ad | %s%d [%an]\" --graph --date=short</span></span><br><span class="line"><span class="string">        undo = reset --hard</span></span><br><span class="line"><span class="string">        llog = log --date=local</span></span><br><span class="line"><span class="string">        changes = diff --name-status -r</span></span><br><span class="line"><span class="string">        diffst = diff --stat -r</span></span><br><span class="line"><span class="string">        conf    = diff --name-only --diff-filter=U</span></span><br><span class="line"><span class="string">[http]</span></span><br><span class="line"><span class="string"># proxy = 127.0.0.1:1080</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[https]</span></span><br><span class="line"><span class="string"># proxy = 127.0.0.1:1080</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[push]</span></span><br><span class="line"><span class="string">        default = simple</span></span><br></pre></td></tr></table></figure>
<p>注意git go 的别名需要自己修改一下your-id</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/npwg-data-serialisation/" itemprop="url">
                  Go 网络编程-数据序列化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-04T12:34:50+08:00" content="2015-11-04">
              2015-11-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <p><img src="/images/golang/gopher-banner-small.jpg" alt=""></p>
<p>这一篇主要是关于Go序列化数据。数据序列化在网络编程中非常重要，在网络传输数据时，如果数据是对象，数组等等，需要先把对象序列化为才能传递，同时接收方需要进行反序列化才能使用这些数据。一个比较常见的是json数据。 序列化和反序列化操作又成为 marshalling 和 unmarshalling 。</p>
<h2 id="序列化方法"><a href="#序列化方法" class="headerlink" title="序列化方法"></a>序列化方法</h2><p>序列化其实简单地说就是一种把变量似乎用字节流表示出来的规范，我们可以定义自己的规范，只要接收方能使用相应的方法反序列化出来原来的对象就可以了。但是我们要考虑序列化方法的通用性，希望对任意的数据可以使用同样的序列化和反序列化方法实现。<br>早期很著名的系列化方法是 XDR(external data representation),它最早用于Sun的RPC中。Go没有对不透数据的marshalling 和 unmarshalling 有明确的支持。RPC包中没有使用XDR，而是使用<code>gob</code>。<br>要实现对数据统一的序列化方法，需要实现一套 <strong>自描述数据</strong>的规范。像xml就是一类自描述的数据，能通过节点属性对数据进行描述。xml还有很强的扩展性。这也是为什么很多项目中会使用xml作为数据传输的格式。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/npwg-data-serialisation/" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/jp-drama-lines/" itemprop="url">
                  台词
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-03T12:34:50+08:00" content="2015-11-03">
              2015-11-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="求婚大作战"><a href="#求婚大作战" class="headerlink" title="求婚大作战"></a>求婚大作战</h2><ul>
<li>光想不做是不行的</li>
<li>以为不说对方也会懂就大错特错</li>
<li>总是说明天再做的是笨蛋</li>
</ul>
<h2 id="东京爱情故事"><a href="#东京爱情故事" class="headerlink" title="东京爱情故事"></a>东京爱情故事</h2><ul>
<li>恋爱这东西，有趣的是在于参与，即使失败了也是很有味道的。因为，你爱上一个人的那个瞬间，是会永远永远留在心里的。这瞬间，便是生活的勇气，便是黑夜里点亮的一盏明灯</li>
<li>恋爱就像一本参考书。即使不成功，人和人相爱的瞬间，那种感觉会永远留下去，只有这样才会让人有继续生存下去的勇气，才能变成一把照亮黑暗的手电筒。要努力喔，我也一起努力。</li>
<li>不是因为身边没有人而寂寞，而是因为身边没有某个人而寂寞。</li>
<li>莉香： （眼中含着泪）你会后悔的，你会后悔的，心里只能有一个爱人，不能有两个，爱我的你在哪儿？24小时都爱我，工作时，玩耍时都爱我，你不是曾经说过这样的话吗？将我抓的牢牢的，把我盯得紧紧的，不然的话，我会离你而去的！ </li>
<li>这种事习惯不了的。和大家分别的时候，心里总是很难过的。所以我，和大家在一起的时候，总是尽情的欢乐。我总是告诫自己，跟谁都要欢欢喜喜的，我想也许再也不会见面了，于是我就拼命的……微笑。</li>
<li>我总认为，要真正爱上一个人是件非常不容易的事情。爱情只是一瞬间的，所以，我觉得，和永尾君的那段感情是很珍贵的，是这样，我爱上了你，你爱上了我，那情景珍藏在我心里，不管明天会发生什么，我的爱是义无返顾的，过去的我是如此，现在的我也是如此，回首往事，我只想说一句话：“青春无悔！”是的，无悔！ </li>
<li>完治： 喂，我一直搞不懂，背这么大的包，里面都放了些什么东西呀？ 莉香： 爱情和希望！ </li>
<li>已经不行了，瞧这儿（胸口），电池已经耗尽了……虽然贴的这么近，……却感到离得那么远……是什么原因 ？总算来了，谢谢你，我好高兴，真的，你来了。不知怎么的……真想和你在一起……但是，为什么呢？…… </li>
</ul>
<h2 id="美丽人生"><a href="#美丽人生" class="headerlink" title="美丽人生"></a>美丽人生</h2><h2 id="恋爱世纪"><a href="#恋爱世纪" class="headerlink" title="恋爱世纪"></a>恋爱世纪</h2><ul>
<li>偶尔不吵架的话，太安静了，会很寂寞。</li>
<li>喜欢一个人，讨厌一个人都是一瞬间的事，可是相信一个人的心情不是那么容易恢复的。</li>
<li>不知怎的，大家都把恋爱幻想得很美丽，想圣诞节两个人要这样过，约会选在那个地方……专注于两人的世界，都不往别的方向看。以同样的心情凝望对方，以为这就是理想的恋爱……实际上又吵架，又伤害对方。互相迁就。……即使这样，还是不想让它这么容易就结束了。恋爱就是这样吧。</li>
<li>我在东京也想过，你昨天说的——自己一个人根本不行，怎么还想要去照顾别人。但是如果那样想的话，两个人一辈子都不能在一起了。所以，其实没什么大不了，一个人不能坚强。所以你也别再说什么要自己坚强起来的话。两个人一起坚强起来不就好了？等我们变成老公公老婆婆，再一起坐在这里看流星吧。</li>
<li>我非常清楚你不可爱的地方，经常也觉得你很可恶，可是无论怎样也不会讨厌你的。这样的心情，我想几十年也不会改变的。所以，请看着我变成老伯吧。我也会看着你的，看你变成老婆婆。</li>
<li>我并不是想表现自己或者是想别人称赞，只是想做一些能向自己交代的工作……我还不想放弃。不想为工作改变自己，所以我想啊，做一些只有自己能胜任的工作。</li>
<li>出人头地。不随波逐流，不理会公司，只做自己认为应该做的事。就是这样，我想变成这样。</li>
<li>绘理香：因为哲平你太温柔了。可是，这种半途而废的温柔只会伤害女人的心。</li>
<li></li>
</ul>
<h2 id="没有玫瑰的花店"><a href="#没有玫瑰的花店" class="headerlink" title="没有玫瑰的花店"></a>没有玫瑰的花店</h2><ul>
<li>为了你自己能够幸福，你应该尝试对一个人温柔。即使最开始不是真心的也没关系，总有一天你会变成一个心地温柔的人。因为对人温柔是一件很幸福的事儿。</li>
</ul>
<h2 id="Good-Luck"><a href="#Good-Luck" class="headerlink" title="Good Luck"></a>Good Luck</h2><ul>
<li><h2 id="一公升的眼泪"><a href="#一公升的眼泪" class="headerlink" title="一公升的眼泪"></a>一公升的眼泪</h2></li>
</ul>
<h2 id="悠长假期"><a href="#悠长假期" class="headerlink" title="悠长假期"></a>悠长假期</h2><h2 id=""><a href="#" class="headerlink" title="#"></a>#</h2><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li>回过头来看，那些曾经让自己寝食难安的事，大多败给了想象。</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/network-programming-with-go-2/" itemprop="url">
                  Go 网络编程-Socket接口与IP套接字
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-02T12:34:50+08:00" content="2015-11-02">
              2015-11-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><img src="/images/golang/gopher-banner-small.jpg" alt=""></p>
<h2 id="UDP数据报"><a href="#UDP数据报" class="headerlink" title="UDP数据报"></a>UDP数据报</h2><p>关于UDP的部分在 <a href="http://wuxu92.github.io/go-lang-notebook-2/" target="_blank" rel="noopener">这篇</a> 文章里已经介绍了很多了，这里只记录在npwg中出现的内容。</p>
<h2 id="监听多个socket"><a href="#监听多个socket" class="headerlink" title="监听多个socket"></a>监听多个socket</h2><p>一个server一般式监听多个端口服务多个客户端的，这种情况一般会用到轮训的方式。在C中使用 select() 调用让内核去做这个工作。在Go中，为每一个端口分配一个Goroutine来实现。</p>
<h2 id="Conn-PacketConn-Listener-类型"><a href="#Conn-PacketConn-Listener-类型" class="headerlink" title="Conn, PacketConn, Listener 类型"></a>Conn, PacketConn, Listener 类型</h2><p>前面的TCP和UDP使用了不同的API，比如TCPConn和UDPConn其实它们都是实现了 Conn 接口。所以之前的写法也都可以直接使用 Conn 实现，这样可以不需要在代码中区分 TCP和 UDP而直接使用 <code>Dial</code> 方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func Dial(net, laddr, raddr string) (c Conn, e os.Error)</span><br></pre></td></tr></table></figure>
<p>需要注意的是，这里的 laddr 和 raddr 都是字符串，也就是 host:port 这样的形式的字符串，而不需要向之前那样先使用 <code>net.ResolveUDPAddr</code> 或者 <code>net.ResolveTCPAddr</code> 先解析出地址。因为可以兼顾TCP/UDP/IP数据，所以net参数可以为 <code>tcp, tcp4, tcp6, udp, udp4, udp6, ip, ip4, ip6</code>。这个方法返回一个Conn接口的实例。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">conn, _ := net.Dial(&quot;tcp&quot;, &quot;zhihu.com:80&quot;)</span><br><span class="line">conn.Write([]byte(&quot;HEAD / HTTP/1.0\r\n\r\n&quot;))</span><br><span class="line">var buffer = make([]byte, 512)</span><br><span class="line">if n, err := conn.Read(buffer); err == nil &#123;</span><br><span class="line">	fmt.Println(&quot;response&quot;, n, &quot;\n&quot;, string(buffer))</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	fmt.Println(&quot;err occur&quot;, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个更加简化的使用接口实现的Head程序。但是这样写有一个问题，如果服务器端返回的内容超多了512个字节，那么buffer不能存储这么多，那么就只会读到前512个字节的内容，后面的被丢弃。我们需要是用一个缓冲区来存储（这部分可以封装为一个方法，读取所有返回）。Read部分改如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">result := bytes.NewBuffer(nil)</span><br><span class="line">var buf [512]byte</span><br><span class="line">for &#123;</span><br><span class="line">	n, err ：= conn.Read(buf[0:])</span><br><span class="line">	result.Write(buf[0:n])</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		if err == io.EOF &#123;</span><br><span class="line">			break</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Pritnln(&quot;err&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(&quot;res&quot;, result.Bytes())</span><br></pre></td></tr></table></figure>
<p>而对于server端，可以不需要ListenUDP或者ListenTCP而直接使用 <code>Listen</code> 方法，它会返回一个实现了 <code>Listener</code> 接口的对象。其对应的方法签名如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func Listen(net, laddr string) (l Listener, err os.Error)</span><br><span class="line">func (l Listener) Accept() (c Conn, err os.Error)</span><br></pre></td></tr></table></figure>
<p>同样需要注意Listen的laddr是一个字符串了，而不是解析过的TCPAddr或者UDPAddr。<br>对应UDP使用 <code>ListenPacket(net, laddr string) (c PacketConn, err os.Error)</code> 方法。</p>
<h2 id="使用更原始的IP套接字"><a href="#使用更原始的IP套接字" class="headerlink" title="使用更原始的IP套接字"></a>使用更原始的IP套接字</h2><p>这一节我们讨论一下一般情况下不太需要的原始套接字，这可以构建我们自己的IP协议或者使用TCP和UDP之外的协议。<br>TCP和UDP不是IP层上仅有的协议。现在大概有140种这样的协议（参看 <code>/etc/protocls</code>）。<br>Go可以通过原始套接字使用户使用这些协议进行通信。</p>
<p>我们可以使用原始套接字实现一个icmp客户端程序，也就是ping命令。我们要注意的是ping不是传输层应用，不使用TCP或者UDP也就<strong>没有端口的概念</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	addr, _ := net.ResolveIPAddr(&quot;ip&quot;, &quot;baidu.com&quot;)</span><br><span class="line">	conn, err = net.DialIP(&quot;ip4:icmp&quot;, nil, addr)</span><br><span class="line">	CheckErr(err)</span><br><span class="line"></span><br><span class="line">	var msg [512]byte   // icmp 报文</span><br><span class="line">	msg[0] = 8</span><br><span class="line">	msg[1] = 0</span><br><span class="line">	msg[2] = 0</span><br><span class="line">	msg[3] = 0</span><br><span class="line">	msg[4] = 0</span><br><span class="line">	msg[5] =  13</span><br><span class="line">	msg[6] = 0</span><br><span class="line">	msg[7] = 37</span><br><span class="line">	len := 8</span><br><span class="line">	check := checkSum(msg[:len])</span><br><span class="line">	msg[2] = byte(check &gt;&gt; 8)</span><br><span class="line">	msg[3] = byte(check &amp; 255)</span><br><span class="line">	_, err = conn.Write(msg[0:len])</span><br><span class="line">	CheckErr(err)</span><br><span class="line">	fmt.Println(&quot;wites&quot;, (msg[0:len]))</span><br><span class="line">	n, err := conn.Read(msg[0:])</span><br><span class="line">	CheckErr(err)</span><br><span class="line">	fmt.Println(&quot;got ping res&quot;, n)</span><br><span class="line">	if msg[5] == 13 &#123;</span><br><span class="line">		fmt.Println(&quot;ping identifier matches&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	if msg[7] == 37 &#123;</span><br><span class="line">		fmt.Println(&quot;ping sequence matches&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">// 计算校验和</span><br><span class="line">func checkSum(msg []byte) uint16 &#123;</span><br><span class="line">	sum := 0</span><br><span class="line">	for n := 1; n &lt; len(msg)-1; n += 2 &#123;</span><br><span class="line">		sum += int(msg[n])*256 + int(msg[n+1])</span><br><span class="line">	&#125;</span><br><span class="line">	sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff)</span><br><span class="line">	sum += (sum &gt;&gt; 16)</span><br><span class="line">	var ans uint16 = uint16(^sum)</span><br><span class="line">	return ans</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func CheckErr(err error) &#123;</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		fmt.Fprintf(os.Stderr, &quot;err %s&quot;, err.Error())</span><br><span class="line">		os.Exit(1)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码在Windows下使用管理员运行也没有结果（使用非管理员运行会提示权限不足），会在<code>Read(msg[:])</code> 那里卡住，但是在Linux运行是可以的，不过后面那端matches的不知道干什么的，读到的返回的数据的内容大概是这样的： <code>[69 0 0 28 45 250 64 0 64 1 216 33 10 4 16 95 10 4 16 95 8 0 242 255 0 13 0 37]</code></p>
<p>下一张 数据序列化</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/golang-local-document/" itemprop="url">
                  Go 启用本地文档
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-10-31T12:34:50+08:00" content="2015-10-31">
              2015-10-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Go很“先进”的一点在于它的文档和提供的文档工具 godoc ，但是由于golang的官网被 万能的GFW 干掉了，有时候要查文档很不方便。虽然翻墙也不麻烦，但是如果能有个本地的文档那就更方便了。</p>
<p>以往的本地文档都是以PDF或者CHM的形式存在，使用的应该都能感觉他们的缺点，PDF缺乏组织，查找/索引很不方便，而CHM限于Windows的技术支持，并且有时候也不是很方便。</p>
<p>实际上Go的安装包里提供了基础包的文档，他就保存在 <code>GOROOT/doc</code>（好像不是这个目录） 下，是一些html文件，当然我们可以直接浏览器打开，有一种更见好用的方式是用godoc提供的http服务，在命令行运行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">godoc -http:6060 &amp;</span><br><span class="line">// &amp; 表示后台运行，windows下可能需要保持命令行窗口不关闭，如果要关闭窗口且保持服务运行</span><br><span class="line">// 需要先运行 eixt 然后再关闭窗口，要关闭进程可以新开一个bash，ps找到PID后Kill</span><br></pre></td></tr></table></figure>
<p>这条命令会监听6060端口的http请求，提供和golang.org同样的页面服务 。浏览器打开 <code>http://localhost:6060</code> 就可以方便的查看文档啦。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/network-programming-with-go/" itemprop="url">
                  Go 网络编程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-10-29T12:34:50+08:00" content="2015-10-29">
              2015-10-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <p><img src="/images/golang/gopher-banner-small.jpg" alt=""></p>
<p>对于任何一门语言，网络编程都是重要的一部分。对于Go来说其天生的高并发网络编程更是充满魅力。所以今天开学学习Go网络编程部分，教材是 Jan Newmarch 的 Network programming with Go 的pdf文档。 这份文档在 <a href="https://jan.newmarch.name/go/" target="_blank" rel="noopener">这里</a> 可以找到，由 Astaxie 翻译的中文版也在<a href="https://jan.newmarch.name/go/zh/index.html" target="_blank" rel="noopener">这个网站的这个目录</a>， 当然也可以在<a href="https://github.com/astaxie/NPWG_zh" target="_blank" rel="noopener">astaxie的github上</a>找到。</p>
<p>我使用英文的pdf，因为没有找到中午的pdf，而使用pdf比网页要方便些，方便做笔记和添加备注，并且这类文档的英文应该也不会太难。</p>
<p>根据pdf的结构，一节一节往后走。各章节组成如下：</p>
<ol>
<li>架构</li>
<li>Go语言概括</li>
<li>Socket编程</li>
<li>数据序列化</li>
<li>应用层协议</li>
<li>管理字符集与编码</li>
<li>安全</li>
<li>HTTP</li>
<li>模板</li>
<li>一个完整的Web服务</li>
<li>HTML</li>
<li>XML</li>
<li>远程过程调用RPC</li>
<li>网络 Channels</li>
<li>Web Sockets</li>
</ol>
<p>其中前两张只简单的过一下，重要的是这几节： Socket, 序列化，应用层协议，安全，HTTP。 RPC与Web Sockets。其他章节看起来简单过一下就可以了。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/network-programming-with-go/" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/postgresql-views-fk-and-trans/" itemprop="url">
                  PostgreSQL 视图，外键与事物
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-10-27T12:34:50+08:00" content="2015-10-27">
              2015-10-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/db/" itemprop="url" rel="index">
                    <span itemprop="name">db</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><img src="/images/logo/postgresql.png" alt=""></p>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>视图提供了在真是数据表上建立抽象数据表的功能，可以封装数据表结构的细节，是一种很好的sql设计。实际中也会经常使用视图，使用基于视图的查询会方便很多。<br>创建视图的语法和mysql很像，我们知道mysql实现视图有两种算法，临时表方法和~~忘了另一种是什么了，它们的实现区别导致它们的性能有差异。在pg中创建视图似乎不需要考虑这么多，直接创建就可以了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create view view_name as select subcluase</span><br></pre></td></tr></table></figure>
<p>select 子句中还可以基于其它视图查询，基于视图创建视图也是很常见的。不过可能太多层的视图创建会对查询性能有影响。要设计好的表结构，尽量避免多层的视图依赖。</p>
<h2 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h2><p>MySQL 的MyISAM引擎是不支持外键的，只有Innodb引擎可以支持外键。pg由于并没有多引擎的设计，所以在建表时不需要考虑这些，因为它就是支持外键的。</p>
<p>实际中，很多人并不太喜欢使用外键，比如我自己在设计数据库的时候也不喜欢用外键。一个是外键理解起来有点麻烦；二是外键的级联删除总觉得不太放心，不是自己操作的嘛。。。在使用外键的地方使用一张关联表也是很方便的。在插入删除的时候也就是多一句操作。</p>
<p>这里给一个官方的使用外键的例子，理解起来还是很方便的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE cities (</span><br><span class="line">        city     varchar(80) primary key,</span><br><span class="line">        location point</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE weather (</span><br><span class="line">        city      varchar(80) references cities(city),</span><br><span class="line">        temp_lo   int,</span><br><span class="line">        temp_hi   int,</span><br><span class="line">        prcp      real,</span><br><span class="line">        date      date</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>也许使用外键是一个不错的习惯，以后的数据表应该学习使用外键。</p>
<h2 id="事物"><a href="#事物" class="headerlink" title="事物"></a>事物</h2><p>事物使得一系列数据库操作打包成一个动作，保证中间不被打断以保证数据完整性。当其中一个操作出错时，系统会自动回滚到最初的状态，即这是一个 all-ot-nothing 的操作。<br>一个常见的食物操作的场景是转账或者付款交易。要保证A账号转出的数额与B账号受到的数额相等，不能A转出了B没有收到，也不能A还没转B就收到了。转账操作在数据库中至少需要两条语句，要保证这两天语句要么都成功，要么就都失败。<br>另外还要保证事物处理过程中，对外界是不可见的。</p>
<blockquote>
<p>The updates made so far by an open transaction are invisible to other transactions until the transaction completes, whereupon all the updates become visible simultaneously</p>
</blockquote>
<p>pg中的事物非常的简单，只要是在 <code>BEGIN;</code> 和 <code>COMMIT;</code> 之间的操作就被看错一个事物。当然放到现实业务系统中，不同的驱动有不同的实现。<br>实际上可以把所有的语句都理解为事物，这是一个有意思的理解</p>
<blockquote>
<p>PostgreSQL actually treats every SQL statement as being executed within a transaction. If you do not issue a BEGIN command, then each individual statement has an implicit BEGIN and (if successful) COMMIT wrapped around it. A group of statements surrounded by BEGIN and COMMIT is sometimes called a transaction block</p>
</blockquote>
<p>这里还有一个叫做 <code>savepoint</code> 的概念，在mysql中没有这个东西，pg的事务处理中，可以设置savepoint，以允许设置rollback的位置。使用 roolback to savepoint 可以保留savepoint之前的修改。一个示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">UPDATE accounts SET balance = balance - 100.00</span><br><span class="line">    WHERE name = &apos;Alice&apos;;</span><br><span class="line">SAVEPOINT my_savepoint;</span><br><span class="line">UPDATE accounts SET balance = balance + 100.00</span><br><span class="line">    WHERE name = &apos;Bob&apos;;</span><br><span class="line">-- oops ... forget that and use Wally&apos;s account</span><br><span class="line">ROLLBACK TO my_savepoint;</span><br><span class="line">UPDATE accounts SET balance = balance + 100.00</span><br><span class="line">    WHERE name = &apos;Wally&apos;;</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure>
<h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><ul>
<li>avg</li>
<li>rank</li>
<li>sum</li>
</ul>
<p>这部分和MySQL中很不一样，提供了更丰富的特性。吃饭去了，下次再写吧。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="wuxu" itemprop="image"/>
          <p class="site-author-name" itemprop="name">wuxu</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Wu Xu的个人博客</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">176</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">24</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">147</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wuxu92" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/wuxu92" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/kiwidock" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/wuxu92" target="_blank">
                  
                    <i class="fa fa-douban"></i> Douban
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/wuxu92" target="_blank">
                  
                    <i class="fa fa-zhihu"></i> Zhihu
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wuxu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
